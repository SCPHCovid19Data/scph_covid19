---
title: "scph_covid"
author: "Hayden Hedman"
date: "10/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(pacman)
pacman::p_load(dplyr, data.table, bit64, curl, tidyr, zoo)
```

(1) SUMMARY DATA
```{r }
## SET WORKING DIRECTORY
setwd("C:/Users/GODZILLA/Google Drive/Summit County - COVID-19/Database/Datawrapper")
## LOAD DATA
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)
df <- as.data.frame(df)
## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
df<- subset(df, !duplicated(unique_id))
###############################################################################################################
elr_df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/elr_rollup_Summit.txt'); dim(df)
elr_df <- as.data.frame(elr_df)
##
  TT_sum <- elr_df %>%
  filter(test_type == "PCR") %>% 
  select(dateadded, total_tests) %>% 
  distinct() %>% 
  mutate(sum = sum(total_tests))
  TT_1 <- tail(TT_sum, 1)
  TT = TT_1$sum
####################################################################
## DAILY VALUES ENTERED
O = 75
DA = 5
DD = 3
## SUMMARIZE DAILY REPORT
total_summ <- data.frame(group_by(df) %>% 
                         summarize(pos_confirm_sum = sum(casestatus=="confirmed"),
                                   prob_sum = sum(casestatus=="probable"),
                                   total_cases = sum(pos_confirm_sum, prob_sum),
                                   death_sum = sum(outcome=="Patient died"),
                                   hospitalized_sum = sum(hospitalized=="TRUE"))); print(total_summ)

type_eng = c("Confirmed Positive Tests", "Probable Cases", "Total Cases", "Hospitalizations", "Total Tested*", "Outbreaks", "Deaths Among Cases", "Deaths Due to COVID-19")
type_esp = c("Pruebas positivas confirmadas", "Casos probables", "Total de casos", "Hospitalizaciones", "Total de pruebas", "Brotes", "Muertes entre casos", "Muertes debidas a COVID-19")

value = c(total_summ$pos_confirm_sum, total_summ$prob_sum, total_summ$total_cases, total_summ$hospitalized_sum, TT, O, DA, DD)
summary_eng <- data.frame(type_eng, value)
summary_esp <- data.frame(type_esp, value)
## SUMMARY TABLE (ENG)
write.csv(summary_eng, row.names = F, "summary_table_eng.csv")
## SUMMARY TABLE (ESP)
write.csv(summary_esp, row.names = F, "summary_table_esp.csv")
```

(2) PCR TEST PROPORTION AND NEGATIVE TEST COUNTS
```{r }
## LOAD DATA
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/elr_rollup_Summit.txt'); dim(df)
##df <- read.csv("elr_rollup_Summit.csv", header=T); dim(df)
##############################################################################################
## FILTER DF OF ONLY PCR OUTCOMES
df <- as.data.frame(df)
df <- subset(df, test_type=="PCR"); dim(df)
##############################################################################################
## Summarize sum of  tests by dateadded
total_tests <- data.frame(group_by(df, dateadded) %>%
                           summarize(total_tested = sum(n_tests))); dim(total_tests)
##############################################################################################
## CREATE TEMP ID TO FILTER OUT DATES UP TO 2020-03-13
total_tests$sort_ID <- as.integer(factor(with(total_tests, paste(dateadded))))
## FILTER OUT DATES BEFORE 13-MARCH-2020
total_tests <- subset(total_tests, sort_ID >3); dim(total_tests)
total_tests <- arrange(total_tests, -sort_ID); head(total_tests)
##############################################################################################
## PULL OUT POSITIVE DF BUT FILTER BY DUPLICATED DATEADDED 
## THE SUM OF POSITIVE TESTS IS SAME ACCROSS CDPHE AND NON-CDPHE LAB TYPES (2X)
pos_tests <- df[!duplicated(df[3]),]; dim(pos_tests)

## PULL OUT MEANINGFUL VARIABLES
pos_tests <- pos_tests[,c("total_confirmed_cases", "county", "dateadded")]; dim(pos_tests)

## CREATE TEMP ID TO FILTER OUT DATES UP TO 2020-03-13
pos_tests$sort_ID <- as.integer(factor(with(pos_tests, paste(dateadded))))
## SORT OLDEST TO NEWEST M
pos_tests <- arrange(pos_tests, sort_ID); head(pos_tests)
## MAKE SURE 3/10 - 3/12 ARE REMOVED
pos_tests <- subset(pos_tests, sort_ID > 3)
## SORT BACK TO NEWEST TO OLDEST
pos_tests <- arrange(pos_tests, -sort_ID); head(pos_tests)
## REMOVE DATEADDED VARIABLE - THIS IS HERE JUST FOR QUALITY CONTROL
pos_tests$dateadded = NULL

##############################################################################################
## CBIND UP THE POSITIVE AND TOTAL TESTS
df2 <- cbind(total_tests, pos_tests); dim(df2)
## CORRECT FOR CDPHE DATA ENTRY ERRORS (SOMETIMES THEY HAVE 0 TOTAL & POS >0)
## IMPORTANT THAT NONE OF THE % >> 100 OR = INF
setDT(df2)[total_tested <total_confirmed_cases, total_tested := total_confirmed_cases]
## SUBSTRACT TOTAL-POS = SUM NEG TESTS
df2$total_neg_tests = df2$total_tested-df2$total_confirmed_cases
## CALCULATE PROPORTION OF POSITIVE TESTS [Total Number of PCR POSITIVE Tests/Total Number of PCR Tests]
df2$positive_prop = (df2$total_confirmed_cases/df2$total_tested)*100
## CONVERT ALL NAN PROPORTIONS (I.E. 0/0) TO 0
df2$positive_prop[is.na(df2$positive_prop)] <- 0
## REMOVE PLACEHOLDER 'COUNTY' VARIABLE
df2$county = NULL
############################################################################################
## CALCULATE MOVING 3-DAY MEAN OF POSITIVE PROP
#df2$sort_ID <- as.integer(factor(with(df2, paste(dateadded))))
#df2 <- arrange(df2, -sort_ID); head(df2)
## TEMPORARILY UNLOAD PACKAGES
unloadNamespace("dplyr")
## CALCULATE MOVING 3-DAY MEAN OF POSITIVE PROP
df2$avg_3day <- filter(df2$positive_prop, rep(1/3,3)); head(df2)


demo <- head(df2)
demo<- arrange(demo, -sort_ID); head(demo)
demo$avg_3day <- filter(demo$positive_prop, rep(1/3,3)); head(demo)


############################################################################################
## LAST CONFIRMATION THAT DF MATCHES ORGINAL DIMESNIONS
dim(df2)
##############################################################################################
## PULL OUT VARIABLES FOR DF'S
## 1) POSITIVE PROPORTION
pos_percent_df <- df2[,c("dateadded", "positive_prop", "avg_3day")]
## CLEAN COLUMN NAMES - ENG
colnames(pos_percent_df)[1] <- "Date"
colnames(pos_percent_df)[2] <- "Percentage of Tests Confirmed Positive"
colnames(pos_percent_df)[3] <- "3-Day Moving Average Percentage of Confirmed Positive Tests"
##############################################################################################
## SUBSET LAST 30-DAY PERIOD
pos_percent_df$sort_ID <- as.integer(factor(with(pos_percent_df, paste(Date))))
## SORT BY TEMP ID
pos_percent_df <- arrange(pos_percent_df, -sort_ID); head(pos_percent_df)
pos_percent_df_sub <- head(pos_percent_df, 30); dim(pos_percent_df_sub)
pos_percent_df$sort_ID= NULL
pos_percent_df_sub$sort_ID= NULL

##############################################################################################
## 1) TEST COUNT - ENG
test_count_df <- df2[,c("dateadded", "total_tested", "total_confirmed_cases")]
## CLEAN COLUMN NAMES
colnames(test_count_df)[1] <- "Date"
colnames(test_count_df)[2] <- "Total People Tested"
colnames(test_count_df)[3] <- "People Confirmed Positive"

test_count_df <- test_count_df[,c("Date", "Total People Tested")]
## SAVE PCR COUNT DF
total_pcr_pos <- df2[,c("dateadded", "total_tested", "total_confirmed_cases")]

write.csv(total_pcr_pos, "pcr_count_df.csv", row.names=F)
##############################################################################################
## SUBSET LAST 30-DAY PERIOD
test_count_df$sort_ID <- as.integer(factor(with(test_count_df, paste(Date))))
## SORT BY TEMP ID
test_count_df <- arrange(test_count_df, -sort_ID); head(test_count_df)
test_count_df_sub <- head(test_count_df, 30); dim(test_count_df_sub)
test_count_df$sort_ID= NULL
test_count_df_sub$sort_ID= NULL

##############################################################################################
## WRITE TO CSV - ENG
write.csv(pos_percent_df, row.names=FALSE, "pos_percent_eng.csv")
write.csv(test_count_df, row.names=FALSE, "test_count_eng.csv")
## 30-DAY PERIOD - ENG
write.csv(pos_percent_df_sub, row.names=FALSE, "pos_percent_30day_eng.csv")
write.csv(test_count_df_sub, row.names=FALSE, "test_count_30day_eng.csv")
##############################################################################################
## 1) POSITIVE PROPORTION - ESP
pos_percent_ESP_df <- pos_percent_df
colnames(pos_percent_ESP_df)[1] <- "Fecha"
colnames(pos_percent_ESP_df)[2] <- "Porcentaje de pruebas que son positivas"
colnames(pos_percent_ESP_df)[3] <- "Promedio de 3 dias"
## WRITE CSV
write.csv(pos_percent_ESP_df, row.names=FALSE, "pos_percent_esp.csv")
########################################################################################################
## 30 DAY PERIOD - POS PERCENNT (ESP)
## 1.5) POSITIVE PROPORTION - ESP
pos_percent_ESP_sub <- pos_percent_df_sub
colnames(pos_percent_ESP_sub)[1] <- "Fecha"
colnames(pos_percent_ESP_sub)[2] <- "Porcentaje de pruebas que son positivas"
colnames(pos_percent_ESP_sub)[3] <- "Promedio de 3 dias"
## WRITE CSV
write.csv(pos_percent_ESP_sub, row.names=FALSE, "pos_percent_30day_esp.csv")
########################################################################################################
## 2) TEST COUNT - ENG
test_count_ESP_df <- test_count_df
## CLEAN COLUMN NAMES
colnames(test_count_ESP_df)[1] <- "Fecha"
colnames(test_count_ESP_df)[2] <- "Total de Pruebas"
colnames(test_count_ESP_df)[3] <- "Resultados Positivos"


test_count_ESP_df <- test_count_ESP_df[,c("Fecha", "Total de Pruebas")]


########################################################################################################
## WRITE CSV
write.csv(test_count_ESP_df, row.names=FALSE, "test_count_esp.csv")
########################################################################################################
## 30 DAY PERIOD - TESTING (ESP)
test_count_ESP_sub <- test_count_ESP_df
test_count_ESP_sub <- head(test_count_ESP_sub, 30); dim(test_count_ESP_sub)

## WRITE CSV
write.csv(test_count_ESP_sub, row.names=FALSE, "test_count_30day_esp.csv")
########################################################################################################
```

(3) DAILY COUNTY CASES, HOSPITALIZATIONS, DEATHS
```{r }
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)
## CONVERT DATA CLASS TO DATA.FRAME
df <- as.data.frame(df)
## SUBSET ONLY COUNTY == SUMMIT (CLEANS OUT POTENTIAL ERROR FROM FORMATTING)
df <- subset(df, county=="SUMMIT"); dim(df)
## filter out duplicates
df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
df<- subset(df, !duplicated(unique_id))

## LOAD PREVIOUSLY CREATED test_count_df from #2
date_df <- read.csv("test_count_eng.csv", header=T)
########################################################################################################
## 2. DATA CLEANING
df <- df[!is.na(df$casestatus),];dim(df)

## FORMAT DATE: YYYY-MM-DD - In case need to convert date format
#df$reporteddate <- format(as.Date(df$reporteddate, "%Y-%m-%d"), "%Y-%m-%d")
#date_df$Date <- format(as.Date(date_df$Date, "%m/%d/%Y"), "%Y-%m-%d")
########################################################################################################
## CREATE SUBSET FOR ONLY DEATH CASES
##  NOTE: DEATHDATE DOES NOT = REPORTDATE BUT MERGING TO HAVE A COMMON DATE FIELD
df.death <- subset(df, outcome=="Patient died"); dim(df.death)
df.death <- df.death[,c("outcome", "deathdate")]; dim(df.death)
df.death$reporteddate <- df.death$deathdate
df.death$deathdate <- NULL
df.death$death_count = 1
########################################################################################################
## PULL OUT DATE DF VARIABLES
date_df <- date_df[,c("Date", "Total.People.Tested")]
########################################################################################################
## 3. SUMMARIZE COUNT POSITIVES, NEGATIVES, TOTAL TESTS, AND PROP POSITIVES BY DATE
require(dplyr)
day_summ <- data.frame(group_by(df, reporteddate) %>% 
                         summarize(pos_confirm_sum = sum(casestatus=="confirmed"),
                                   prob_sum = sum(casestatus=="probable"),
                                   total_pos_case_sum = sum(pos_confirm_sum,prob_sum)))
dim(day_summ)

########################################################################################################
## 4. POSITIVE DATA MERGED WITH DEATH DATA
## IMPORTANT MAKE SURE DATES ARE ALL YYYY-MM-DD
summ_death_pos <- merge(x= day_summ, y=df.death, by=c("reporteddate"), all.x=T); dim(summ_death_pos)
## REPLACE NA WITH 0 FOR DEATH COUNT
summ_death_pos$outcome= NULL
summ_death_pos[is.na(summ_death_pos)]<- 0
########################################################################################################
## 5. ADD HOSPITALIZATION DF WITH SUMM_DEATH_ADD
hosp_df <- read.csv("Landing_-_Hospitals_data.csv", header=T)
colnames(hosp_df)[1]<-"Date"
hosp_df <- hosp_df[,c("Date", "Value")]

hosp_df <- hosp_df[!duplicated(hosp_df[1]),]

hosp_df$Date <- format(as.Date(hosp_df$Date, "%m/%d/%Y"), "%Y-%m-%d")

write.csv(hosp_df, "hosp_df_temp.csv", row.names=F)

#hosp_df <- read.csv("hosp_df.csv", header=T)
colnames(hosp_df)[1]<- "reporteddate"
colnames(hosp_df)[2]<- "hosp_count"

## SUMMARIZE HOSPITAL DATA BY REPORTEDDATE
#hosp_df <- data.frame(group_by(hosp_df, reporteddate) %>% 
 #                        summarize(hospitalization_count = sum(hosp_count=="1")))
## FORMAT DATE FORMAT TO YYYY-MM-DD
#hosp_df$reporteddate <- format(as.Date(hosp_df$reporteddate, "%m/%d/%Y"), "%Y-%m-%d")
########################################################################################################
## STORE HISTORICAL HOSPITAL DF
write.csv(hosp_df, "hospital_historical.csv", row.names=F)

## SUBSET LAST 30-DAY PERIOD
hosp_df2<-hosp_df
hosp_df2$sort_ID <- as.integer(factor(with(hosp_df2, paste(Date))))
## SORT BY TEMP ID
hosp_df2 <- arrange(hosp_df2, -sort_ID); head(hosp_df2)
hosp_df2_sub <- head(hosp_df2, 30); dim(hosp_df2_sub)
hosp_df2_sub$sort_ID=NULL

write.csv(hosp_df2_sub, "hospital_8wks.csv", row.names=F)

########################################################################################################
## HOSP + DATE
colnames(hosp_df)[1]<-"Date"
hosp_date <- merge(x=date_df,y=hosp_df, by=c("Date"), all=T);dim(hosp_date)

## ADD DEATH+POS & HOSP_DF
summ_death_pos$reporteddate <- as.character(summ_death_pos$reporteddate)
colnames(summ_death_pos)[1]<-"Date"
summ_death_pos_hosp <- merge(x=hosp_date, y = summ_death_pos, by = c("Date"), all.x=T)
## ADD "0" VALUES FOR ALL NA ENTRIES
summ_death_pos_hosp$death_count[is.na(summ_death_pos_hosp$death_count)] <- 0
summ_death_pos_hosp$hosp_count[is.na(summ_death_pos_hosp$hosp_count)] <- 0

## ALL MEANINGFUL COLUMNS WITH NA = 0
summ_death_pos_hosp[is.na(summ_death_pos_hosp)] <- 0

## PULL OUT MEANINGFUL VARIABLES
compiled_df <- summ_death_pos_hosp[,c("Date", "total_pos_case_sum", "death_count","hosp_count")]
## CHECK NO BLANKS ROWS INCLUDED
compiled_df <- subset(compiled_df, Date !=""); dim(compiled_df)
#####################################################################################
## PULL OUT VARIABLES OF INTEREST
compiled_df2 <- compiled_df[,c("Date","total_pos_case_sum", "death_count", "hosp_count")]

## CLEAN UP VARIABLE NAMES FOR .CSV FILE
colnames(compiled_df2)[1] <- "Date"
colnames(compiled_df2)[3] <- "Deaths"
colnames(compiled_df2)[2] <- "Cases"
colnames(compiled_df2)[4] <- "Hospitalizations"

## SUBSET LAST 30-DAY PERIOD
compiled_df2$sort_ID <- as.integer(factor(with(compiled_df2, paste(Date))))
## SORT BY TEMP ID
compiled_df2 <- arrange(compiled_df2, -sort_ID); head(compiled_df2)
compiled_df_sub <- head(compiled_df2, 30); dim(compiled_df_sub)
compiled_df2$sort_ID= NULL
compiled_df_sub$sort_ID=NULL
## WRITE CSV AND INCLUDE DATE AS A PROOFREADING APPROACH
write.csv(compiled_df2,row.names=FALSE, "daily_count_eng.csv")
## WRITE CSV 30-DAY PERIOD
write.csv(compiled_df_sub,row.names=FALSE, "daily_count_30d_eng.csv")

#####################################################################################
## CREATE SPANISH FILE
compiled_df_esp <- compiled_df2
## CHANGE VARIABLE NAMES TO SPANISH
colnames(compiled_df_esp)[1] <- "Fecha"
colnames(compiled_df_esp)[2] <- "Casos"
colnames(compiled_df_esp)[3] <- "Muertes"
colnames(compiled_df_esp)[4] <- "Hospitalizaciones"

## WRITE CSV
write.csv(compiled_df_esp,row.names=FALSE, "daily_count_esp.csv")
## SUBSET LAST 30-DAY PERIOD
compiled_df_esp$sort_ID <- as.integer(factor(with(compiled_df_esp, paste(Fecha))))
## SORT BY TEMP ID
compiled_df_esp <- arrange(compiled_df_esp, -sort_ID); head(compiled_df_esp)
compiled_df_esp_sub <- head(compiled_df_esp, 30); dim(compiled_df_esp_sub)
compiled_df_esp_sub$sort_ID= NULL

write.csv(compiled_df_esp_sub,row.names=FALSE, "daily_count_30d_esp.csv")


```

(4) DEMOGRAPHICS SUMMARY
```{r }
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)
##############################################################################################
## CONVERT DATA CLASS TO DATA.FRAME
df <- as.data.frame(df)
## SUBSET ONLY COUNTY == SUMMIT (CLEANS OUT POTENTIAL ERROR FROM FORMATTING)
df <- subset(df, county=="SUMMIT"); dim(df)
##############################################################################################
## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
df<- subset(df, !duplicated(unique_id))
##############################################################################################
## EXCLUDE UNKNOWN SEX 
df$exclude = 0
df$exclude[which(df$gender=="Unknown")] <- "1"
##############################################################################################
## AVOID RISK OF REPORTING NON-BINARY GENDERS IN DATA PUBLIC TO COMMUNITY  
## SUBSET & SUMMARIZE BY 1) AGE, 2) SEX, 3) RACE/ETHNIC
df <- subset(df, exclude=="0");dim(df)
## MADE A DUMMY VARIABLE FOR INDEX MEASUREMENTS BY DEMOGRAPHICS
df$index_measure=1
##############################################################################################
## AGE CLASS
## ASSIGN AGE CLASS VARIABLE IN BINS OF 10 YEARS
df$age_class = 0
df$age_class[which(df$age_at_reported < 10)] <- "0-9"
df$age_class[which(df$age_at_reported > 9 & df$age_at_reported < 20)] <- "10-19"
df$age_class[which(df$age_at_reported > 19 & df$age_at_reported < 30)] <- "20-29"
df$age_class[which(df$age_at_reported > 29 & df$age_at_reported < 40)] <- "30-39"
df$age_class[which(df$age_at_reported > 39 & df$age_at_reported < 50)] <- "40-49"
df$age_class[which(df$age_at_reported > 49 & df$age_at_reported < 60)] <- "50-59"
df$age_class[which(df$age_at_reported > 59 & df$age_at_reported < 70)] <- "60-69"
df$age_class[which(df$age_at_reported > 69 & df$age_at_reported < 80)] <- "70-79"
df$age_class[which(df$age_at_reported >= 80)] <- "80+"
##############################################################################################
## SUMMARIZE BY AGE CLASS
age_summ <- data.frame(group_by(df, age_class) %>% 
                         summarize(sum_cases = sum(index_measure=="1")))
## PREPARE AGE HEADER FOR .CSV
colnames(age_summ)[1] <- "Age Group"
colnames(age_summ)[2] <- "Number of Cases"
write.csv(age_summ,row.names=FALSE, "age_summ_eng.csv")
##############################################################################################
## SEX
sex_summ <- data.frame(group_by(df, gender) %>% 
                         summarize(sum_cases = sum(index_measure=="1")))

## PREPARE AGE HEADER FOR .CSV
# NOTE: CDPHE ONLY REPORTS SEX
colnames(sex_summ)[1] <- "Sex" 
colnames(sex_summ)[2] <- "Number of Cases"

write.csv(sex_summ,row.names=FALSE, "sex_summ_eng.csv")
##############################################################################################
## TRANSLATE SEX VARIABLES TO SPANISH
sex_summ_esp <- sex_summ

sex_summ_esp$Sexo = 0
sex_summ_esp$Sexo[which(sex_summ_esp$Sex=="Female")] <- "Mujeres"
sex_summ_esp$Sexo[which(sex_summ_esp$Sex=="Male")] <- "Hombres"

## REMOVE VARIABLE 'SEX'
sex_summ_esp$Sex = NULL
## WRITE .CSV
write.csv(sex_summ_esp,row.names=FALSE, "sex_summ_esp.csv")
##############################################################################################
## CREATE NEW VARIABLE (race_ethnic) FOR RACE+ETHNICITY 
df$race_ethnic = 0
df$race_ethnic[which(df$single_race_ethnicity_with_ciis=="White - Non Hispanic")] <- "White"
df$race_ethnic[which(df$single_race_ethnicity_with_ciis=="Hispanic, All Races")] <- "Hispanic/Latinx"
df$race_ethnic[which(df$single_race_ethnicity_with_ciis!="Hispanic, All Races" & df$single_race_ethnicity_with_ciis!="White - Non Hispanic")] <- "Other"

## SUMMARIZE BY RACE & ETHNICITY
race_summ <- data.frame(group_by(df, race_ethnic) %>% 
                         summarize(sum_cases = sum(index_measure=="1")))

## WRITE .CSV
write.csv(race_summ,row.names=FALSE, "race_summ_eng.csv")
##############################################################################################
## RACE/ETHNICITY SUMMARY TRANSLATED TO SPANISH
race_summ_esp <- race_summ

## SET DUMMY VARIABLE
race_summ_esp$race_ethnic_esp= 0
## CHANGE RACE/ETHNICITY TO ESP
race_summ_esp$race_ethnic_esp[which(race_summ_esp$race_ethnic=="Hispanic/Latinx")] <- "Hispano/Latinx"
race_summ_esp$race_ethnic_esp[which(race_summ_esp$race_ethnic=="Other")] <- "Otros"
race_summ_esp$race_ethnic_esp[which(race_summ_esp$race_ethnic=="White")] <- "Blanco"

## PULL ONLY MEANINGFUL VARIABLES
race_summ_esp <- race_summ_esp[,c("race_ethnic_esp", "sum_cases")]

## WRITE CSV
write.csv(race_summ_esp, row.names=FALSE, "race_summ_esp.csv")
```

PON MILESTONE #1 - HOSPITAL OCCUPANCY & HOSPITAL ADMISSIONS
```{r }
## LOAD DATA
df <- read.csv("compiled_hospital_dataset.csv", header=T)
hosp_count <- read.csv("daily_count_eng.csv", header=T)
##############################################################################################
## HOSP ADMISSIONS DF FOR MILESTONES
hosp_count <- hosp_count[,c("Date", "Hospitalizations")]
## CLEAN UP VARIABLES
colnames(hosp_count)[2]<- "Hospital Admissions"
## CREATE TEMP SORT ID
hosp_count$sort_ID <- as.integer(factor(with(hosp_count, paste(Date))))
## SORT BY TEMP ID
hosp_count <- arrange(hosp_count, -sort_ID); head(hosp_count)
##############################################################################################
## HISTORICAL HOSPITAL COUNT DATA
hosp_count <- hosp_count[,c(1:2)]
##WRITE.CSV
write.csv(hosp_count, row.names=FALSE,"pon_hosp_count_hist.csv")
##############################################################################################
## 8-WEEK HOSPITAL COUNT DATA
hosp_count <- head(hosp_count, 56); dim(hosp_count)
hosp_count$sort_ID = NULL
## WRITE TO CSV
write.csv(hosp_count, row.names=FALSE,"pon_hosp_count_8wk.csv")
##############################################################################################
## HOSPITAL OCCUPANCY 
## CHANGE DATE FORMAT
df$date <- format(as.Date(df$date, "%m/%d/%Y"), "%Y-%m-%d")
##############################################################################################
## SUMMARIZE DAILY % HOSPITAL BED OCCUPANCY (N, BEDS = 34)
df$max_threshold= 80.0
hosp_occ <- df[,c("date","prop_occ","max_threshold")]
##############################################################################################
## CREATE PROXY TEMP_ID 
hosp_occ$sort_ID <- as.integer(factor(with(hosp_occ, paste(date))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
hosp_occ <- arrange(hosp_occ, -sort_ID); head(hosp_occ)
hosp_occ$sort_ID = NULL
##############################################################################################
## HISTORICAL HOSPITAL OCCUPANCY (ENG)
hosp_occ <- na.omit(hosp_occ)
colnames(hosp_occ)[1] <- "Date"
colnames(hosp_occ)[2] <- "Bed Occupancy (%)"
colnames(hosp_occ)[3] <- "Goal (80% or lower)"
## WRITE CSV - HISTORICAL HOSPITAL OCCUPANCY
write.csv(hosp_occ,row.names=FALSE, "pon_hosp_occ_hist_eng.csv")
##############################################################################################
## HISTORICAL HOSPITAL OCCUPANCY (ESP)
hosp_occ_esp <- hosp_occ
colnames(hosp_occ_esp)[1] <- "Fecha"
colnames(hosp_occ_esp)[2] <- "Cupo de camas (%)"
colnames(hosp_occ_esp)[3] <- "Meta (80% o menos)"
## WRITE CSV - HISTORICAL HOSPITAL OCCUPANCY (ESP)
write.csv(hosp_occ_esp,row.names=FALSE, "pon_hosp_occ_hist_esp.csv")
##############################################################################################
## SUBSET 8-WEEK DATA (ENG)
hosp_occ_8wk_eng <- head(hosp_occ, 56); dim(hosp_occ_8wk_eng)
write.csv(hosp_occ_8wk_eng,row.names=FALSE, "pon_hosp_occ_8wk_eng.csv")
##############################################################################################
## SUBSET 8-WEEK DATA (ESP)
hosp_occ_8wk_esp <- head(hosp_occ_esp, 56); dim(hosp_occ_8wk_esp)
write.csv(hosp_occ_8wk_esp,row.names=FALSE, "pon_hosp_occ_8wk_esp.csv")
##############################################################################################
```

PON MILESTONE #2 - CUMULATIVE 14-D INCIDENCE PER 100,000
```{r }
## COVID-19 14-DAY CUMULATIVE INCIDENCE (POSITIVE TESTS + PCR)
pos_df <- read.csv("daily_count_eng.csv", header=T) ## COMPILED PCR DF 
##############################################################################################
## CHANGE FORMAT OF DATEADDED
##pos_df$Date <- format(as.Date(pos_df$Date, "%m/%d/%Y"), "%Y-%m-%d")

##############################################################################################
## PULL OUT MEANINGFUL VARIABLES
pos_df <- pos_df[,c("Date","Cases")]; dim(pos_df)
## CREATE PROXY TEMP_ID 
pos_df$sort_ID <- as.integer(factor(with(pos_df, paste(Date))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
pos_df <- arrange(pos_df, -sort_ID); head(pos_df)
# ASSIGN ID FOR 14-DAY INTERVALS 
pos_df$ID <-rep(1:100, each=14, length.out=nrow(pos_df)); head(pos_df)
##############################################################################################
## 14-DAY MOVING SUM
  pos_df <- pos_df %>%
    arrange(sort_ID,Date) %>%
    mutate(rollapply_sum =zoo::rollapplyr(Cases, 14, sum, partial = TRUE)) # requires package zoom
##############################################################################################
##############################################################################################
  ## CUMULATIVE 14-DAY INCIDENCE (TOTAL NUMBER OF POSITIVE CASES PER 14D) 
  ## MUST MULTIPLE BY SUM OF POSITIVE CASES AND POPULATION FACTOR
  ## POPULATION VALUE IS TAKEN FROM CO DEMOGRAPHY 2018 POPULATION SIZE
pos_df$pos_case_14d <- pos_df$rollapply_sum*(100000/30974)
##############################################################################################
## HISTORICAL INCIDENCE (ENG)
pos_hist <- pos_df
## PREPARE FILE FOR CSV
pos_hist$target1 = 75
pos_hist$target2 = 175
pos_hist$target3 = 350
pos_hist$min = 0
pos_hist$max = max(pos_hist$pos_case_14d)
pos_hist <- pos_hist[,c("Date","pos_case_14d","min","target1","target2","target3", "max")]
colnames(pos_hist)[2] <- "Rolling 14-Day Positive Cases Per 100,000"
colnames(pos_hist)[4] <- "Level Blue: Caution"
colnames(pos_hist)[5] <- "Level Yellow: Concern"
colnames(pos_hist)[6] <- "Level Orange: High Risk"
colnames(pos_hist)[7] <- "Level Red: Severe Risk"


##WRITE CSV
write.csv(pos_hist, row.names=FALSE,"pon_incidence_hist_eng.csv")
##############################################################################################
## HISTORICAL INCIDENCE (ESP)
pos_hist_esp <- pos_hist
colnames(pos_hist_esp)[1] <- "Fecha"
colnames(pos_hist_esp)[2] <- "positivos nuevos por 100,000 personas en los 14 dias anteriores"
colnames(pos_hist_esp)[4] <- "Nivel Azul: Precacion"
colnames(pos_hist_esp)[5] <- "Nivel Amarillo: Preocupaction"
colnames(pos_hist_esp)[6] <- "Nivel Anaranjado: Alto Riesgo"
colnames(pos_hist_esp)[7] <- "Nivel Rojo: Reisgo severo"

## WRITE CSV
write.csv(pos_hist_esp, row.names=FALSE,"pon_incidence_hist_esp.csv")
##############################################################################################
## SUBSET 8-WEEK DATA
pos_df <- arrange(pos_df, -sort_ID); head(pos_df)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
pos_df <- head(pos_df, 56); dim(pos_df)
## PREPARE FILE FOR CSV
pos_df$target1 = 75
pos_df$target2 = 175
pos_df$target3 = 350
pos_df$min=0
pos_df$max = max(pos_df$pos_case_14d)

pos_df2 <- pos_df[,c("Date","pos_case_14d","min", "target1","target2","target3", "max")]
##############################################################################################
## 8-WEEK INCIDENCE (ENG)
colnames(pos_df2)[2] <- "Rolling 14-Day Positive Cases Per 100,000"
colnames(pos_df2)[4] <- "Level Blue: Caution"
colnames(pos_df2)[5] <- "Level Yellow: Concern"
colnames(pos_df2)[6] <- "Level Orange: High Risk"
colnames(pos_df2)[7] <- "Level Red: Severe Risk"

## WRITE CSV
write.csv(pos_df2, row.names=FALSE,"pon_incidence_8wk_eng.csv")
##############################################################################################
## 8-WEEK INCIDENCE (ESP)
pos_df2_esp <- pos_df2
colnames(pos_df2_esp)[1] <- "Fecha"
colnames(pos_df2_esp)[2] <- "positivos nuevos por 100,000 personas en los 14 dias anteriores"
colnames(pos_df2_esp)[4] <- "Nivel Azul: Precacion"
colnames(pos_df2_esp)[5] <- "Nivel Amarillo: Preocupaction"
colnames(pos_df2_esp)[6] <- "Nivel Anaranjado: Alto Riesgo"
colnames(pos_df2_esp)[7] <- "Nivel Rojo: Reisgo severo"

## WRITE CSV
write.csv(pos_df2_esp, row.names=FALSE,"pon_incidence_8wk_esp.csv")
```

PON MILESTONE #3 - CUMULATIVE 14-D PERCENT PCR POSITIVE
```{r }
## 14-DAY PCR POSITIVITY RATE
## LOAD DATA
df <- read.csv("pcr_count_df.csv", header=T)
##############################################################################################
## CHANGE FORMAT OF DATEADDED (*If Needed)
#df$Date <- format(as.Date(df$Date, "%m/%d/%Y"), "%Y-%m-%d")
##############################################################################################
## CLEAN UP VARIABLE NAMES FOR SIMPLICITY
colnames(df)[1]<-"Date" # Date
colnames(df)[2]<-"total_pcr" # TOTAL NUMBER OF PCR TESTS
colnames(df)[3]<-"pos_pcr"   # NUMBER OF POSITIVE CONFIRMED TESTS
##############################################################################################
## REMOVE GARBAGE DATES
start_date = "2020-03-10"
start_date = as.Date(start_date)
df$Date <- as.Date(df$Date)
df <- subset(df, Date > start_date)
##############################################################################################
## CREATE PROXY ID FOR SORTING - DF SHOULD ALREADY BE ORDERED NEWEST TO OLDEST BUT JUST AS A CHECK
df$sort_ID <- as.integer(factor(with(df, paste(Date))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
df <- arrange(df, -sort_ID); head(df)
##############################################################################################
## 14-DAY MOVING SUM
df <- df %>%
  arrange(sort_ID,Date) %>%
  mutate(rollapply_pos_sum =zoo::rollapplyr(pos_pcr, 14, sum, partial = TRUE)) # need package zoom

df <- df %>%
  arrange(sort_ID,Date) %>%
  mutate(rollapply_total_sum =zoo::rollapplyr(total_pcr, 14, sum, partial = TRUE)) # need package zoom
##############################################################################################
##############################################################################################
## 1)14-DAY POSITIVITY RATE 
df$pos_pcr_rate <- (df$rollapply_pos_sum/df$rollapply_total_sum)*100
df$pcr_pos_target1 = 5
df$pcr_pos_target2 = 10
df$pcr_pos_target3 = 15
df$min = 0
df$max = max(df$pos_pcr_rate)
## ARRANGE NEWEST TO OLDEST DATE
df <- arrange(df, -sort_ID); head(df)


##############################################################################################
## HISTORICAL DATA (ENG)
pcr_pos_perc_hist_eng <- df[,c("Date","pos_pcr_rate", "min", "pcr_pos_target1", "pcr_pos_target2", "pcr_pos_target3", "max")]
colnames(pcr_pos_perc_hist_eng)[2] <- "Rolling 14-Day Percent of Tests Positive"
colnames(pcr_pos_perc_hist_eng)[4] <- "Level Blue: Caution"
colnames(pcr_pos_perc_hist_eng)[5] <- "Level Yellow: Concern"
colnames(pcr_pos_perc_hist_eng)[6] <- "Level Orange: High Risk"
colnames(pcr_pos_perc_hist_eng)[7] <- "Level Red: Severe Risk"

## WRITE CSV
write.csv(pcr_pos_perc_hist_eng, row.names=FALSE,"pon_pos_rate_hist_eng.csv")
##############################################################################################
## HISTORICAL DATA (ESP)
pcr_pos_perc_hist_esp <- df[,c("Date","pos_pcr_rate", "min", "pcr_pos_target1", "pcr_pos_target2", "pcr_pos_target3", "max")]
colnames(pcr_pos_perc_hist_esp)[1] <- "Fecha"
colnames(pcr_pos_perc_hist_esp)[2] <- "Porcentaje de pruebas positivas durante los 14 dias anteriores"
colnames(pcr_pos_perc_hist_esp)[4] <- "Nivel Azul: Precacion"
colnames(pcr_pos_perc_hist_esp)[5] <- "Nivel Amarillo: Preocupaction"
colnames(pcr_pos_perc_hist_esp)[6] <- "Nivel Anaranjado: Alto Riesgo"
colnames(pcr_pos_perc_hist_esp)[7] <- "Nivel Rojo: Reisgo severo"

## WRITE CSV
write.csv(pcr_pos_perc_hist_esp, row.names=FALSE,"pon_pos_rate_hist_esp.csv")
##############################################################################################
## SUBSET OUT LAST 8 WEEKS
df <- head(df, 56); dim(df)
##############################################################################################
## 8-WEEK POSITIVITY (ENG)
pcr_pos_perc_eng <- df[,c("Date", "pos_pcr_rate", "min", "pcr_pos_target1", "pcr_pos_target2", "pcr_pos_target3")]
pcr_pos_perc_eng$max = max(pcr_pos_perc_eng$pos_pcr_rate)

colnames(pcr_pos_perc_eng)[2] <- "Rolling 14-Day Percent of Tests Positive"
colnames(pcr_pos_perc_eng)[4] <- "Level Blue: Caution"
colnames(pcr_pos_perc_eng)[5] <- "Level Yellow: Concern"
colnames(pcr_pos_perc_eng)[6] <- "Level Orange: High Risk"
colnames(pcr_pos_perc_eng)[7] <- "Level Red: Severe Risk"

##  WRITE CSV (8-WEEK DATA - ENG)
write.csv(pcr_pos_perc_eng,row.names=FALSE, "pon_pos_rate_8wk_eng.csv")
##############################################################################################
## 8-WEEK POSITIVITY (ESP)
pcr_pos_perc_esp <- pcr_pos_perc_eng
colnames(pcr_pos_perc_esp)[1] <- "Fecha"
colnames(pcr_pos_perc_esp)[2] <- "Porcentaje de pruebas positivas durante los 14 dias anteriores"
colnames(pcr_pos_perc_esp)[4] <- "Nivel Azul: Precacion"
colnames(pcr_pos_perc_esp)[5] <- "Nivel Amarillo: Preocupaction"
colnames(pcr_pos_perc_esp)[6] <- "Nivel Anaranjado: Alto Riesgo"
colnames(pcr_pos_perc_esp)[7] <- "Nivel Rojo: Reisgo severo"

##  WRITE CSV [8 WEEKS OF DATA - ESP]
write.csv(pcr_pos_perc_esp, row.names=FALSE,"pon_pos_rate_8wk_esp.csv")
##############################################################################################
```

PON MILESTONE #3 - TESTING RATE PER 1,000
```{r }
## PROTECT OUR NEIGHBORS PCR TESTING MILESTONE
df <- read.csv("test_count_eng.csv", header=T)
##############################################################################################
## CHANGE FORMAT OF DATEADDED (*If Needed)
#df$Date <- format(as.Date(df$Date, "%m/%d/%Y"), "%Y-%m-%d")
##############################################################################################
## CLEAN UP VARIABLE NAMES FOR SIMPLICITY
colnames(df)[2]<-"total_pcr" # TOTAL NUMBER OF PCR TESTS
## SELECT OUT VARIABLES OF INTEREST
df <- df[,c("Date", "total_pcr")]; dim(df)
##############################################################################################
## CREATE PROXY ID FOR SORTING
df$sort_ID <- as.integer(factor(with(df, paste(Date))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
df <- arrange(df, -sort_ID); head(df)
##############################################################################################
## 7-day MOVING TESTING AVERAGE
df <- df %>%
  arrange(sort_ID,Date) %>%
  mutate(rollapply_7d_avg =zoo::rollapplyr(total_pcr, 7, mean, partial = TRUE)) # need package zoom

#TESTING POPULATION FACTOR PROPORTION
PF_1K = (1000/30974) 
## 7 DAY AVG TESTING RATE 
df$test_rate7d <- (df$rollapply_7d_avg)*PF_1K
## DAILY TESTING RATE
df$test_rate_daily<- (df$total_pcr)*PF_1K

## TESTING POPULATION FACTOR PER 0.75, 1,000 PEOPLE
df$test_target = 0.75
##############################################################################################
## SORT DATE NEWEST TO OLDEST
df <- arrange(df, -sort_ID); head(df)
##############################################################################################
## HISTORICAL TESTING (ENG)
pcr_test_hist_eng <- df[,c("Date","test_rate_daily", "test_rate7d", "test_target")]
colnames(pcr_test_hist_eng)[2] <- "Daily Testing Conducted per 1,000 population"
colnames(pcr_test_hist_eng)[3] <- "7 Day Moving Average"
colnames(pcr_test_hist_eng)[4] <- "Goal (0.75 or higher)"
## WRITE CSV - HISTORICAL TESTING (ENG)
write.csv(pcr_test_hist_eng, row.names=FALSE,"pon_test_rate_hist_eng.csv")
##############################################################################################
## HISTORICAL TESTING (ESP)
pcr_test_hist_esp <- pcr_test_hist_eng
colnames(pcr_test_hist_esp)[1] <- "Fecha"
colnames(pcr_test_hist_esp)[2] <- "Pruebas por 1,000 Personas"
colnames(pcr_test_hist_esp)[3] <- "Promedio de 7 dias"
colnames(pcr_test_hist_esp)[4] <- "Meta (0.75 o mayor)"
## WRITE CSV - HISTORICAL TESTING (ENG)
write.csv(pcr_test_hist_esp, row.names=FALSE,"pon_test_rate_hist_esp.csv")
##############################################################################################
## SUBSET RECENT 8-WEEK DATA
df <- head(df, 56); dim(df)
##############################################################################################
## 8-WEEK TESTING (ENG)
pcr_test_eng <- df[,c("Date","test_rate_daily", "test_rate7d", "test_target")]
colnames(pcr_test_eng)[2] <- "Daily Testing Conducted per 1,000 population"
colnames(pcr_test_eng)[3] <- "7 Day Moving Average"
colnames(pcr_test_eng)[4] <- "Goal (0.75 or higher)"
## WRITE CSV
write.csv(pcr_test_eng, row.names=FALSE,"pon_test_rate_8wk_eng.csv")
##############################################################################################
## 8-WEEK TESTING (ESP)
pcr_test_esp <- pcr_test_eng
colnames(pcr_test_esp)[1] <- "Fecha"
colnames(pcr_test_esp)[2] <- "Pruebas por 1,000 Personas"
colnames(pcr_test_esp)[3] <- "Promedio de 7 dias"
colnames(pcr_test_esp)[4] <- "Meta (0.75 o mayor)"
## WRITE CSV
write.csv(pcr_test_esp, row.names=FALSE,"pon_test_rate_8wk_esp.csv")
```

AGE GROUP PER 100,000
```{r }
## LOAD DATA
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)
##############################################################################################
## CONVERT DATA CLASS TO DATA.FRAME
df <- as.data.frame(df)
## SUBSET ONLY COUNTY == SUMMIT (CLEANS OUT POTENTIAL ERROR FROM FORMATTING)
df <- subset(df, county=="SUMMIT"); dim(df)
## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
df<- subset(df, !duplicated(unique_id))
## COUNT VARIABLE
df$index_measure=1
##############################################################################################
## ADD IN MISSING DUMMY DATES 
total_dates <- data.frame(reporteddate=seq(min(df$reporteddate),max(df$reporteddate),1))
## MERGE DUMMY DATE DF with total case DF
df <- merge(x= total_dates, y=df,by="reporteddate",all.x=TRUE)
df$index_measure[is.na(df$index_measure)] <- 0
##############################################################################################
## CREATE AGE GROUPS
## AGE CLASS
## ASSIGN AGE CLASS VARIABLE IN BINS OF 10 YEARS
df$age_class = 0
df$age_class[which(df$age_at_reported < 10)] <- "0-9"
df$age_class[which(df$age_at_reported > 9 & df$age_at_reported < 20)] <- "10-19"
df$age_class[which(df$age_at_reported > 19 & df$age_at_reported < 30)] <- "20-29"
df$age_class[which(df$age_at_reported > 29 & df$age_at_reported < 40)] <- "30-39"
df$age_class[which(df$age_at_reported > 39 & df$age_at_reported < 50)] <- "40-49"
df$age_class[which(df$age_at_reported > 49 & df$age_at_reported < 60)] <- "50-59"
df$age_class[which(df$age_at_reported > 59 & df$age_at_reported < 70)] <- "60-69"
df$age_class[which(df$age_at_reported > 69 & df$age_at_reported < 80)] <- "70-79"
df$age_class[which(df$age_at_reported >= 80)] <- "80+"
##############################################################################################
## SUMMARIZE BY AGE CLASS & DATE
age_daily <- data.frame(group_by(df, age_class, reporteddate) %>% 
                         summarize(sum_cases = sum(index_measure=="1")))
## ----------------------------------------------------------------------
## DO SOME PRE-MAGIC FOR THE AGE DF
age_daily$sort_ID <- as.integer(factor(with(age_daily, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_daily <- arrange(age_daily, -sort_ID); head(age_daily)
## PULL OUT SELECT NEEDED VARIABLES 
date_ID <- age_daily[,c("reporteddate", "sort_ID")]
date_ID <- date_ID[!duplicated(date_ID[1]),]
colnames(date_ID)[2]<-"ID"
## ----------------------------------------------------------------------
## AGE GROUP (0-9)
age_09 <- subset(age_daily, age_class=="0-9"); dim(age_09)
age_09 <- merge(x= total_dates, y=age_09,by="reporteddate",all.x=TRUE); dim(age_09)
age_09$age_class = "0-9"
age_09$sum_cases[is.na(age_09$sum_cases)] <- 0

age_09$sort_ID <- as.integer(factor(with(age_09, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_09 <- arrange(age_09, -sort_ID); head(age_09)
## 14-DAY MOVING SUM
age_09 <- age_09 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) # requires package zoom
## POPULATION FACTOR
age_09$pos_case_14d <- age_09$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_09_8wk <- arrange(age_09, -sort_ID); head(age_09_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_09_8wk <- head(age_09_8wk, 56); dim(age_09_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (10-19)
age_19 <- subset(age_daily, age_class=="10-19"); dim(age_19)
age_19 <- merge(x= total_dates, y=age_19,by="reporteddate",all.x=TRUE); dim(age_19)
age_19$age_class = "10-19"
age_19$sum_cases[is.na(age_19$sum_cases)] <- 0

age_19$sort_ID <- as.integer(factor(with(age_19, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_19 <- arrange(age_19, -sort_ID); head(age_19)
## 14-DAY MOVING SUM
age_19 <- age_19 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_19$pos_case_14d <- age_19$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_19_8wk <- arrange(age_19, -sort_ID); head(age_19_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_19_8wk <- head(age_19_8wk, 56); dim(age_19_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (20-29)
age_29 <- subset(age_daily, age_class=="20-29"); dim(age_29)
age_29 <- merge(x= total_dates, y=age_29,by="reporteddate",all.x=TRUE); dim(age_29)
age_29$age_class = "20-29"
age_29$sum_cases[is.na(age_29$sum_cases)] <- 0

age_29$sort_ID <- as.integer(factor(with(age_29, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_29 <- arrange(age_29, -sort_ID); head(age_29)
## 14-DAY MOVING SUM
age_29 <- age_29 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_29$pos_case_14d <- age_29$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_29_8wk <- arrange(age_29, -sort_ID); head(age_29_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_29_8wk <- head(age_29_8wk, 56); dim(age_29_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (30-39)
age_39 <- subset(age_daily, age_class=="30-39"); dim(age_39)
age_39 <- merge(x= total_dates, y=age_39,by="reporteddate",all.x=TRUE); dim(age_39)
age_39$age_class = "30-39"
age_39$sum_cases[is.na(age_39$sum_cases)] <- 0

age_39$sort_ID <- as.integer(factor(with(age_39, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_39 <- arrange(age_39, -sort_ID); head(age_39)
## 14-DAY MOVING SUM
age_39 <- age_39 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_39$pos_case_14d <- age_39$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_39_8wk <- arrange(age_39, -sort_ID); head(age_39_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_39_8wk <- head(age_39_8wk, 56); dim(age_39_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (40-49)
age_49 <- subset(age_daily, age_class=="40-49"); dim(age_49)
age_49 <- merge(x= total_dates, y=age_49,by="reporteddate",all.x=TRUE); dim(age_49)
age_49$age_class = "40-49"
age_49$sum_cases[is.na(age_49$sum_cases)] <- 0

age_49$sort_ID <- as.integer(factor(with(age_49, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_49 <- arrange(age_49, -sort_ID); head(age_49)
## 14-DAY MOVING SUM
age_49 <- age_49 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_49$pos_case_14d <- age_49$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_49_8wk <- arrange(age_49, -sort_ID); head(age_49_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_49_8wk <- head(age_49_8wk, 56); dim(age_49_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (50-59)
age_59 <- subset(age_daily, age_class=="50-59"); dim(age_59)
age_59 <- merge(x= total_dates, y=age_59,by="reporteddate",all.x=TRUE); dim(age_59)
age_59$age_class = "50-59"
age_59$sum_cases[is.na(age_59$sum_cases)] <- 0

age_59$sort_ID <- as.integer(factor(with(age_59, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_59 <- arrange(age_59, -sort_ID); head(age_59)
## 14-DAY PERIOD SUM
age_59 <- age_59 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_59$pos_case_14d <- age_59$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_59_8wk <- arrange(age_59, -sort_ID); head(age_59_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_59_8wk <- head(age_59_8wk, 56); dim(age_59_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (60-69)
age_69 <- subset(age_daily, age_class=="60-69"); dim(age_69)
age_69 <- merge(x= total_dates, y=age_69,by="reporteddate",all.x=TRUE); dim(age_69)
age_69$age_class = "60-69"
age_69$sum_cases[is.na(age_69$sum_cases)] <- 0

age_69$sort_ID <- as.integer(factor(with(age_69, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_69 <- arrange(age_69, -sort_ID); head(age_69)
## 14-DAY MOVING SUM
age_69 <- age_69 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_69$pos_case_14d <- age_69$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_69_8wk <- arrange(age_69, -sort_ID); head(age_69_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_69_8wk <- head(age_69_8wk, 56); dim(age_69_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (70-79)
age_79 <- subset(age_daily, age_class=="70-79"); dim(age_79)
age_79 <- merge(x= total_dates, y=age_79,by="reporteddate",all.x=TRUE); dim(age_79)
age_79$age_class = "70-79"
age_79$sum_cases[is.na(age_79$sum_cases)] <- 0

age_79$sort_ID <- as.integer(factor(with(age_79, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_79 <- arrange(age_79, -sort_ID); head(age_79)
## 14-DAY MOVING SUM
age_79 <- age_79 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_79$pos_case_14d <- age_79$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_79_8wk <- arrange(age_79, -sort_ID); head(age_79_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_79_8wk <- head(age_79_8wk, 56); dim(age_79_8wk)
## ----------------------------------------------------------------------
## AGE GROUP (80)
age_80 <- subset(age_daily, age_class=="80+")
age_80 <- merge(x= total_dates, y=age_80,by="reporteddate",all.x=TRUE)
age_80$age_class = "80+"
age_80$sum_cases[is.na(age_80$sum_cases)] <- 0

age_80$sort_ID <- as.integer(factor(with(age_80, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
age_80 <- arrange(age_80, -sort_ID); head(age_80)
## 14-DAY MOVING SUM
age_80 <- age_80 %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) 
## POPULATION FACTOR
age_80$pos_case_14d <- age_80$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
age_80_8wk <- arrange(age_80, -sort_ID); head(age_80_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
age_80_8wk <- head(age_80_8wk, 56); dim(age_80_8wk)
## ----------------------------------------------------------------------
##############################################################################################
## COMPILE AGE CLASSES
age_compile <- rbind(age_09, age_19, age_29, age_39, age_49, age_59, age_69, age_79, age_80); dim(age_compile)
## SORT BY ID
age_compile <- arrange(age_compile, -sort_ID); head(age_compile)
##############################################################################################
## PREPARE DF FOR PUBLISHING
age_compile_2 <- age_compile[,c("reporteddate", "age_class", "pos_case_14d")]
## LONG TO WIDE
age_compile_2 <- spread(age_compile_2, age_class, pos_case_14d, fill = 0)
## CHANGE VARIABLE NAMES
colnames(age_compile_2)[1] <- "Date"
colnames(age_compile_2)[2] <- "0 - 9"
colnames(age_compile_2)[3] <- "10 - 19"
colnames(age_compile_2)[4] <- "20 - 29"
colnames(age_compile_2)[5] <- "30 - 39"
colnames(age_compile_2)[6] <- "40 - 49"
colnames(age_compile_2)[7] <- "50 - 59"
colnames(age_compile_2)[8] <- "60 - 69"
colnames(age_compile_2)[9] <- "70 - 79"
colnames(age_compile_2)[10] <- "80+"
## WRITE CSV HISTORICAL (ENG)
write.csv(age_compile_2, row.names=F, "age_14d_period_historical_eng.csv")


##############################################################################################
## SUBSET LAST 30-DAY PERIOD
age_compile_2$sort_ID <- as.integer(factor(with(age_compile_2, paste(Date))))
## SORT BY TEMP ID
age_compile_2 <- arrange(age_compile_2, -sort_ID); head(age_compile_2)
age_compile_2_sub <- head(age_compile_2, 44); dim(age_compile_2_sub)
age_compile_2$sort_ID= NULL
age_compile_2_sub$sort_ID = NULL
age_compile_2_sub<- tail(age_compile_2_sub, -14)
write.csv(age_compile_2_sub, row.names=F, "age_14d_period_30day_eng.csv")
######################################################################################################
## COMPILE AGE CLASSES - 8 WEEK
age_compile_8wk <- rbind(age_09_8wk, age_19_8wk, age_29_8wk, age_39_8wk, age_49_8wk, age_59_8wk, age_69_8wk, age_79_8wk, age_80_8wk); dim(age_compile_8wk)
## SORT BY ID
age_compile_8wk <- arrange(age_compile_8wk, -sort_ID); head(age_compile_8wk)
## PREPARE DF FOR PUBLISHING
age_compile_8wk_2 <- age_compile_8wk[,c("reporteddate", "age_class", "pos_case_14d")]
## LONG TO WIDE
age_compile_8wk_2 <- spread(age_compile_8wk_2, age_class, pos_case_14d, fill = 0)
## CHANGE VARIABLE NAMES
colnames(age_compile_8wk_2)[1] <- "Date"
colnames(age_compile_8wk_2)[2] <- "0 - 9 years"
colnames(age_compile_8wk_2)[3] <- "10 - 19 years"
colnames(age_compile_8wk_2)[4] <- "20 - 29 years"
colnames(age_compile_8wk_2)[5] <- "30 - 39 years"
colnames(age_compile_8wk_2)[6] <- "40 - 49 years"
colnames(age_compile_8wk_2)[7] <- "50 - 59 years"
colnames(age_compile_8wk_2)[8] <- "60 - 69 years"
colnames(age_compile_8wk_2)[9] <- "70 - 79 years"
colnames(age_compile_8wk_2)[10] <- "80+ years"
## WRITE CSV HISTORICAL (ENG)
write.csv(age_compile_8wk_2, row.names=F, "age_14d_period_8wk_eng.csv")
```

RACE/ETHNICITY PER 100,000
```{r }
## RACE/ETHNICITY
## LOAD DATA
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)
##############################################################################################
## CONVERT DATA CLASS TO DATA.FRAME
df <- as.data.frame(df)
## SUBSET ONLY COUNTY == SUMMIT (CLEANS OUT POTENTIAL ERROR FROM FORMATTING)
df <- subset(df, county=="SUMMIT"); dim(df)
## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
df<- subset(df, !duplicated(unique_id))
## COUNT VARIABLE
df$index_measure=1
## ADD IN MISSING DUMMY DATES 
total_dates <- data.frame(reporteddate=seq(min(df$reporteddate),max(df$reporteddate),1))
## CREATE RACE/ETHNICITY CATEGORIES
df$race_ethnic = 0
df$race_ethnic[which(df$single_race_ethnicity_with_ciis=="White - Non Hispanic")] <- "White"
df$race_ethnic[which(df$single_race_ethnicity_with_ciis=="Hispanic, All Races")] <- "Hispanic/Latinx"
df$race_ethnic[which(df$single_race_ethnicity_with_ciis!="Hispanic, All Races" & df$single_race_ethnicity_with_ciis!="White - Non Hispanic")] <- "Other"
## MERGE DUMMY DATE DF with total case DF
df <- merge(x= total_dates, y=df,by="reporteddate",all.x=TRUE)
df$index_measure[is.na(df$index_measure)] <- 0
## SUMMARIZE BY RACE/ETHNICITY
race_daily <- data.frame(group_by(df, race_ethnic, reporteddate) %>% 
                          summarize(sum_cases = sum(index_measure=="1")))
##############################################################################################
## ----------------------------------------------------------------------
## DO SOME PRE-MAGIC 
race_daily$sort_ID <- as.integer(factor(with(race_daily, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
race_daily <- arrange(race_daily, -sort_ID); head(race_daily)
## PULL OUT SELECT NEEDED VARIABLES 
date_ID <- race_daily[,c("reporteddate", "sort_ID")]
date_ID <- date_ID[!duplicated(date_ID[1]),]
colnames(date_ID)[2]<-"ID"
## ----------------------------------------------------------------------
## WHITE 
race_white <- subset(race_daily, race_ethnic=="White"); dim(race_white)
race_white <- merge(x= total_dates, y=race_white,by="reporteddate",all.x=TRUE); dim(race_white)
race_white$race_ethnic = "White"
race_white$sum_cases[is.na(race_white$sum_cases)] <- 0

race_white$sort_ID <- as.integer(factor(with(race_white, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
race_white <- arrange(race_white, -sort_ID); head(race_white)
## 14-DAY MOVING SUM
race_white <- race_white %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) # requires package zoom
## POPULATION FACTOR
race_white$pos_case_14d <- race_white$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
race_white_8wk <- arrange(race_white, -sort_ID); head(race_white_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
race_white_8wk <- head(race_white_8wk, 56); dim(race_white_8wk)
## ----------------------------------------------------------------------
## LATINX/HISPANIC 
race_hispanic <- subset(race_daily, race_ethnic=="Hispanic/Latinx"); dim(race_hispanic)
race_hispanic <- merge(x= total_dates, y=race_hispanic,by="reporteddate",all.x=TRUE); dim(race_hispanic)
race_hispanic$race_ethnic = "Hispanic/Latinx"
race_hispanic$sum_cases[is.na(race_hispanic$sum_cases)] <- 0

race_hispanic$sort_ID <- as.integer(factor(with(race_hispanic, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
race_hispanic <- arrange(race_hispanic, -sort_ID); head(race_hispanic)
## 14-DAY MOVING SUM
race_hispanic <- race_hispanic %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) # requires package zoom
## POPULATION FACTOR
race_hispanic$pos_case_14d <- race_hispanic$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
race_hispanic_8wk <- arrange(race_hispanic, -sort_ID); head(race_hispanic_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
race_hispanic_8wk <- head(race_hispanic_8wk, 56); dim(race_hispanic_8wk)
## ----------------------------------------------------------------------
## OTHER 
race_other <- subset(race_daily, race_ethnic=="Other"); dim(race_other)
race_other <- merge(x= total_dates, y=race_other,by="reporteddate",all.x=TRUE); dim(race_other)
race_other$race_ethnic = "Other"
race_other$sum_cases[is.na(race_other$sum_cases)] <- 0

race_other$sort_ID <- as.integer(factor(with(race_other, paste(reporteddate))))
## SORT BY PROXY TEMP_ID: NEWEST DATE FIRST
race_other <- arrange(race_other, -sort_ID); head(race_other)
## 14-DAY MOVING SUM
race_other <- race_other %>%
  arrange(-sort_ID,reporteddate ) %>%
  mutate(rollapply_sum =zoo::rollapplyr(sum_cases , 14, sum, partial = TRUE)) # requires package zoom
## POPULATION FACTOR
race_other$pos_case_14d <- race_other$rollapply_sum*(100000/30974)
## SUBSET 8-WEEK DATA
race_other_8wk <- arrange(race_other, -sort_ID); head(race_other_8wk)
## SELECT FIRST 56 ROWS (8WKS OF DATA)
race_other_8wk <- head(race_other_8wk, 56); dim(race_other_8wk)
##################################################################################################
## COMPILE RACE/ETHNICITY - HISTROICAL DATA
compile_race <- rbind(race_other, race_hispanic, race_white); dim(compile_race)
## SELECT MEANINGFUL VARIABLES
compile_race <- compile_race[,c("reporteddate","race_ethnic","pos_case_14d")]
compile_race2 <- spread(compile_race, race_ethnic, pos_case_14d, fill = 0)
## CHANGE VARIABLE NAMES
colnames(compile_race2)[1] <- "Date"

## WRITE CSV (ENG)
write.csv(compile_race2, row.names=F, "race_14d_period_historical_eng.csv")
##
compile_race2$sort_ID <- as.integer(factor(with(compile_race2, paste(Date))))
## SORT BY TEMP ID
compile_race2 <- arrange(compile_race2, -sort_ID); head(compile_race2)
compile_race2_sub <- head(compile_race2, 44); dim(compile_race2_sub)
compile_race2_sub$sort_ID= NULL
compile_race2_sub$sort_ID = NULL
compile_race2_sub<- tail(compile_race2_sub, -14)

write.csv(compile_race2_sub, row.names=F, "race_14d_period_30day_eng.csv")
###########################################################################


##################################################################################################
## COMPILE RACE/ETHNICITY - 8 WEEK DATA
compile_race_8wk <- rbind(race_other_8wk, race_hispanic_8wk, race_white_8wk); dim(compile_race_8wk)
## SELECT MEANINGFUL VARIABLES
compile_race_8wk <- compile_race_8wk[,c("reporteddate","race_ethnic","pos_case_14d")]
compile_race_8wk_2 <- spread(compile_race_8wk, race_ethnic, pos_case_14d, fill = 0)
## CHANGE VARIABLE NAMES
colnames(compile_race_8wk_2)[1] <- "Date"

## WRITE CSV (ENG)
write.csv(compile_race_8wk_2, row.names=F, "race_14d_period_8wk_eng.csv")

## WRITE CSV (ESP)
compile_race_historical_esp <- compile_race2
colnames(compile_race_historical_esp)[1]<- "Fecha"
colnames(compile_race_historical_esp)[2]<- "hispano/latinx"
colnames(compile_race_historical_esp)[3]<- "otro"
colnames(compile_race_historical_esp)[4]<- "blanco"
compile_race_historical_esp$sort_ID = NULL
write.csv(compile_race_historical_esp, row.names=F, "race_14d_historical_esp.csv")
#####################################
compile_race_historical_esp$sort_ID <- as.integer(factor(with(compile_race_historical_esp, paste(Fecha))))
## SORT BY TEMP ID
compile_race_historical_esp <- arrange(compile_race_historical_esp, -sort_ID); head(compile_race_historical_esp)
compile_race_sub3 <- head(compile_race_historical_esp, 44)
compile_race_sub3$sort_ID= NULL
compile_race_historical_esp$sort_ID = NULL
compile_race_sub3<- tail(compile_race_sub3, -14)
write.csv(compile_race_sub3, row.names=F, "race_14d_period_30day_esp.csv")

```

CREATE TABLE OF MOST RECENT ONE-DAY SUMMARY
```{r }

## LOAD DATA
df_elr <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/elr_rollup_Summit.txt'); dim(df)

## SORT BY NEWEST DATES
## CREATE PROXY DATE INTEGER
df_elr$sort_ID <- as.integer(factor(with(df_elr, paste(dateadded))))

df_elr <- arrange(df_elr, -sort_ID); head(df_elr)
max_date <- max(df_elr$dateadded)
df_elr2 <- subset(df_elr, dateadded==max_date); dim(df_elr2)
df_elr3 <- subset(df_elr2, test_type=="PCR"); dim(df_elr3)
df_elr4 <- subset(df_elr3, !duplicated(total_tests));dim(df_elr4)
df_elr4 <- df_elr4[,c("total_tests")]
total_tests <- df_elr4$total_tests
##########################################################################
## CASE DATA SUMMARY
case_df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/cedrs_Summit.txt'); dim(df)

## FILTER OUT DUPLICATE ENTRIES
case_df$unique_id <- as.integer(factor(with(df, paste(profileid, first_name, last_name, date_of_birth))))
case_df<- subset(case_df, !duplicated(unique_id))

df_death <- subset(case_df, outcome=="Patient died"); dim(df_death)
df_death <- df_death[,c("outcome", "deathdate")]; dim(df_death)
df_death$reporteddate <- df_death$deathdate
df_death$deathdate <- NULL
df_death$death_count = 1

## SUBSET OUT TOTAL AND DEATH DF'S == max_date
df_death <- subset(df_death, reporteddate==max_date)
death_sum = sum(df_death$death_count)
case_df2 <- subset(case_df, reporteddate==max_date);dim(case_df2)

hosp_day <- read.csv("hosp_df_temp.csv", header=T)
hosp_day$Date <- as.IDate(hosp_day$Date)
hosp_day2 <- subset(hosp_day, Date==max_date); dim(hosp_day2)
colnames(hosp_day2)[2]<-"hosp_count"
hosp_day_total = hosp_day2$hosp_count


## MEGA DF
day_summary <- data.frame(group_by(case_df2, reporteddate) %>% 
                         summarize(pos_confirm_sum = sum(casestatus=="confirmed"),
                                   prob_sum = sum(casestatus=="probable"),
                                   total_pos_case_sum = sum(pos_confirm_sum,prob_sum)))

day_summary <- subset(day_summary, reporteddate==max_date)

day_summary2 <- cbind(day_summary,death_sum,hosp_day_total,death_sum, total_tests)
day_summary2 <- day_summary2[,c("reporteddate","hosp_day_total", "death_sum", "pos_confirm_sum", "prob_sum","total_pos_case_sum", "total_tests")]

            

## CLEAN UP TABLE NAMES
colnames(day_summary2)[1]<-"Reported Date"
colnames(day_summary2)[2]<-"Hospital Admissions"
colnames(day_summary2)[3]<-"Deaths"
colnames(day_summary2)[4]<-"Confirmed positive tests"
colnames(day_summary2)[5]<-"Probables"
colnames(day_summary2)[6]<-"Total Cases"
colnames(day_summary2)[7]<-"Total Tests"
## WRITE CSV
write.csv(day_summary2, "SCPH_Daily_Summary_Report.csv", row.names = F)

```

TESTING BY SOURCE SUMMARY
```{r }
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/elr_tests_Summit.txt'); dim(df)
df <- as.data.frame(df)
## REMOVE ALL NAs
df$resultdate <- as.character(df$resultdate)
df <- subset(df, !resultdate=="")
df <- df[!is.na(df$resultdate),]

df<- subset(df, county=="SUMMIT")
## FILTER ONLY PCR
df<- subset(df, test_type=="PCR")


## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(first_name, last_name, date_of_birth, dateadded))))
df<- subset(df, !duplicated(unique_id))
## FILTER OUT ONLY SUMMIT
#df$dateadded <- as.character(df$dateadded)
#test_check <- subset(df, dateadded=="2020-11-22");dim(test_check) ## all checks out!!


########################################################
## SOURCE = 0 | garbage
## SOURCE  = 1 | CENTURA
## SOURCE = 2 | VAIL

df$source = 0
## CENTURA
df$source[which(df$submitter=="ST ANTHONY SUMMIT MEDICAL CENTER")] <- "1"
df$source[which(df$submitter=="CENTURA HEALTHCARE")] <- "1"
df$source[which(df$submitter=="CENTURA HEALTH DEFAULT")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY HEALTHCARE")] <- "1"
df$source[which(df$submitter=="CHPG COVID MOBILE TESTING")] <- "1"
df$source[which(df$submitter=="CMM MAIN")] <- "1"
df$source[which(df$submitter=="ST ANTHONY HOSPITAL")] <- "1"
df$source[which(df$submitter=="ST ANTHONY SUMMIT MEDICAL CTR")] <- "1"
df$source[which(df$submitter=="WORKSAFE CENTURA")] <- "1"
df$source[which(df$submitter=="CENTURA LABORATORY SERVICES")] <- "1"
df$source[which(df$submitter=="LABCORP.COM SEROLOGY TESTING")] <- "1"
df$source[which(df$submitter=="HIGH COUNTRY SUMMIT OB")] <- "1"
df$source[which(df$submitter=="CENTURA OCC MED RED PACKET")] <- "1"
df$source[which(df$submitter=="PORTER ADVENTIST HOSPITAL")] <- "1"
df$source[which(df$submitter=="AVON EMERGENCY AND URGENT CARE CENTER")] <- "1"
df$source[which(df$submitter=="SUMMIT CARDIOLOGY")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY PRIMARY CARE FRISCO")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY PRIMARY CARE SILVERTHORNE")] <- "1"
df$source[which(df$submitter=="PARKER ADVENTIST HOSPITAL")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY OBGYN")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY PRIMARY CARE BRECKENRIDGE")] <- "1"
df$source[which(df$submitter=="CHPG PRIM CARE SOUTHMOOR")] <- "1"
df$source[which(df$submitter=="CHPG PRIMARY CARE SOUTHMOOR")] <- "1"
df$source[which(df$submitter=="OCCMED-#0620-CO-LAKEWOOD")] <- "1"
df$source[which(df$submitter=="AVISTA ADVENTIST HOSPITAL")] <- "1"
df$source[which(df$submitter=="BRECKENRIDGE MEDICAL CENTER")] <- "1"
df$source[which(df$submitter=="CENTRA HEALTH")] <- "1"
df$source[which(df$submitter=="CENTURA NEURO CONCUSSION")] <- "1"
df$source[which(df$submitter=="CHPG HIGH COUNTRY WOMEN'S HEALTH FRISCO")] <- "1"
df$source[which(df$submitter=="CHPG PRIMARY CARE HIGHLANDS")] <- "1"
df$source[which(df$submitter=="CHPG PRIMARY CARE MERCY")] <- "1"
df$source[which(df$submitter=="MIDDLE PK MED KREMM CPU")] <- "1"
df$source[which(df$submitter=="SAINT ANTHONY CENTRAL (CENTURA)")] <- "1"
##########################################################################################################
### VAIL HEALTH
df$source[which(df$submitter=="VAIL HEALTH HOSPITAL")] <- "2"
df$source[which(df$submitter=="VAIL VALLEY MED CTR LAB I/F")] <- "2"
df$source[which(df$submitter=="COLORADO MOUNTAIN MEDICAL-AVON/EDWA")] <- "2"
df$source[which(df$submitter=="COLORADO MOUNTAIN MEDICAL-VAIL")] <- "2"
df$source[which(df$submitter=="VAIL VALLEY MEDICAL CENTER EMERGENCY")] <- "2"
df$source[which(df$submitter=="CMM-AVON")] <- "2"
df$source[which(df$submitter=="CMM-EAGLE")] <- "2"
df$source[which(df$submitter=="COLORADO MOUNTAIN MEDICAL")] <- "2"
df$source[which(df$submitter=="CDH-SILVERTHORNE REC CENTER")] <- "2"
df$source[which(df$submitter=="VAIL INTEGRATIVE MEDICAL")] <- "2"

##########################################################################################################
## SUBSET ONLY CENTURA & VAIL
df <- subset(df, source == "1" | source == "2")

## SUMMARIZE TESTING BY SOURCE

daily_test_source <- data.frame(group_by(df, dateadded) %>% 
                           summarize(centura_sum = sum(source=="1"),
                                     vail_sum = sum(source=="2")))

## CREATE TEMP ID TO FILTER OUT DATES UP TO 2020-03-13
daily_test_source$sort_ID <- as.integer(factor(with(daily_test_source, paste(dateadded))))
## FILTER OUT DATES BEFORE 13-MARCH-2020
daily_test_source <- arrange(daily_test_source, -sort_ID); head(daily_test_source)
daily_test_source$sort_ID = NULL
## RENAME VARIABLES
colnames(daily_test_source)[1]<-"Date"
colnames(daily_test_source)[2]<-"Centura_Sum"
colnames(daily_test_source)[3]<-"Vail_Sum"

## WRITE CSV
write.csv(daily_test_source, "Summit_Testing_Source_Daily_Summary.csv", row.names=F)
```

SASMC HOSPITAL DATA
```{r }
sasmc <- read.csv("compiled_hospital_dataset.csv", header=T)
sasmc <- sasmc[,c("date","covid_pac","covid_pac_trans")]

## FORMAT DATE: YYYY-MM-DD - In case need to convert date format
sasmc$date <- format(as.Date(sasmc$date, "%m/%d/%Y"), "%Y-%m-%d")

colnames(sasmc)[1]<-"Date"
colnames(sasmc)[2]<-"COVID-19 Patients"
colnames(sasmc)[3]<-"COVID-19 Patient Transfers"

write.csv(sasmc, "sasmc_historical_eng.csv", row.names=F)

## SASMC DATA (ESP)
sasmc_esp <- sasmc
colnames(sasmc_esp)[1]<-"Fecha"
colnames(sasmc_esp)[2]<-"Paciente COVID-19"
colnames(sasmc_esp)[3]<-"Traslados de pacientes COVID-19"
write.csv(sasmc_esp, "sasmc_historical_esp.csv", row.names=F)
## 30-DAY PERIOD (ENG)
sasmc30d <- sasmc
## CREATE TEMP ID TO FILTER OUT DATES UP TO 2020-03-13
sasmc30d$Date <- as.character(sasmc30d$Date)
sasmc30d$sort_ID <- as.integer(factor(with(sasmc30d, paste(Date))))
## FILTER OUT DATES BEFORE 13-MARCH-2020
sasmc30d <- arrange(sasmc30d, -sort_ID); head(sasmc30d)
sasmc30d <- head(sasmc30d, 30); dim(sasmc30d)
sasmc30d$sort_ID = NULL
## WRITE CSV (ENG)
write.csv(sasmc30d, "sasmc_30d_eng.csv", row.names=F)
## WRITE CSV (ESP)
sasmc30d_esp <- sasmc30d
colnames(sasmc30d_esp)[1]<-"Fecha"
colnames(sasmc30d_esp)[2]<-"Paciente COVID-19"
colnames(sasmc30d_esp)[3]<-"Traslados de pacientes COVID-19"
## WRITE CSV (ESP)
write.csv(sasmc30d_esp, "sasmc_30d_esp.csv", row.names=F)
```


Mako Silverthorne Summary 
```{r }
df <- fread('https://www.dcphrapps.dphe.state.co.us/Authenticated/Reporting/Downloads/elr_tests_Summit.txt'); dim(df)
df <- as.data.frame(df)

## REMOVE ALL NAs
df$resultdate <- as.character(df$resultdate)
df <- subset(df, !resultdate=="")
df <- df[!is.na(df$resultdate),]

df<- subset(df, county=="SUMMIT")
## FILTER ONLY PCR
df<- subset(df, test_type=="PCR")


## FILTER OUT DUPLICATE ENTRIES
df$unique_id <- as.integer(factor(with(df, paste(first_name, last_name, date_of_birth, dateadded))))
df<- subset(df, !duplicated(unique_id))

mako <- subset(df, sender=="MAKO MEDICAL LABORATORIES" & submitter=="CDH-SILVERTHORNE REC CENTER");dim(mako)

mako$freq = 1
mako$dateadded<- as.Date(mako$dateadded)

daily_test_mako <- data.frame(group_by(mako, dateadded) %>% 
                                  summarize(Sum_Mako_Silverthorne_Tests = sum(freq)))

write.csv(daily_test_mako, "daily_test_mako.csv", row.names=F)
```